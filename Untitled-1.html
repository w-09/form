<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>營造業人員進場登記</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-4">
  <h2 class="text-center">營造業人員進場登記</h2>
  <form id="workerForm" class="mt-4">
    <input type="text" id="name" placeholder="姓名" class="form-control mb-2" required>
    <select id="type" class="form-select mb-2" required>
      <option value="">選擇工種</option>
      <option>鋼筋工</option>
      <option>模板工</option>
      <option>水電工</option>
      <option>泥作工</option>
      <option>焊接工</option>
      <option>其他</option>
    </select>
    <input type="text" id="company" placeholder="所屬廠商" class="form-control mb-2" required>
    <button type="submit" class="btn btn-primary w-100">新增人員</button>
  </form>

  <button id="uploadBtn" class="btn btn-success w-100 mt-3">批次上傳到Google試算表</button>

  <div id="message" class="mt-3"></div>
</div>

<script>
const APPS_SCRIPT_URL = '你的Google Apps Script 部署網址';

let workers = JSON.parse(localStorage.getItem('workers')) || [];

document.getElementById('workerForm').addEventListener('submit', e => {
  e.preventDefault();
  const worker = {
    name: document.getElementById('name').value,
    type: document.getElementById('type').value,
    company: document.getElementById('company').value,
    entryTime: new Date().toLocaleTimeString('zh-TW', {hour12:false})
  };
  workers.push(worker);
  localStorage.setItem('workers', JSON.stringify(workers));
  document.getElementById('workerForm').reset();
  showMessage(`新增成功：${worker.name}`, 'success');
});

document.getElementById('uploadBtn').addEventListener('click', () => {
  if (workers.length === 0) {
    showMessage('沒有資料可上傳', 'danger');
    return;
  }

  fetch(APPS_SCRIPT_URL, {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: 'data=' + encodeURIComponent(JSON.stringify(workers))
  })
  .then(res => res.json())
  .then(res => {
    if (res.result === 'success') {
      showMessage(res.message, 'success');
      workers = [];
      localStorage.removeItem('workers');
    } else {
      showMessage(res.message, 'danger');
    }
  })
  .catch(err => {
    console.error(err);
    showMessage('上傳失敗，請檢查網路或後端設定', 'danger');
  });
});

function showMessage(msg, type) {
  document.getElementById('message').innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
}
</script>
</body>
</html>
