<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工地人員進場登記系統</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            padding-bottom: 70px;
        }
        .form-label {
            font-weight: bold;
        }
        .table th {
            background-color: #f8f9fa;
        }
        .toast-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1050;
        }
    </style>
</head>
<body>
    <!-- 頂部導航欄 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-building me-2"></i>工地人員進場登記系統
            </a>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="container mt-4">
        <!-- 登記表單 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person-plus me-2"></i>新增人員
                </h5>
            </div>
            <div class="card-body">
                <form id="workerForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="workerType" class="form-label">工種</label>
                            <input type="text" class="form-control" id="workerType" required list="workerTypeList">
                            <datalist id="workerTypeList">
                                <option value="鋼筋工">
                                <option value="模板工">
                                <option value="水電工">
                                <option value="泥作工">
                                <option value="木工">
                                <option value="油漆工">
                                <option value="搬運工">
                            </datalist>
                        </div>
                        <div class="col-md-6">
                            <label for="workerCount" class="form-label">人數</label>
                            <input type="number" class="form-control" id="workerCount" min="1" value="1" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="workLocation" class="form-label">位置</label>
                            <input type="text" class="form-control" id="workLocation" required list="locationList">
                            <datalist id="locationList">
                                <option value="A棟">
                                <option value="B棟">
                                <option value="C棟">
                                <option value="地下室">
                                <option value="公共區域">
                            </datalist>
                        </div>
                        <div class="col-md-6">
                            <label for="entryTime" class="form-label">進場時間</label>
                            <input type="time" class="form-control" id="entryTime" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="workContent" class="form-label">工作內容</label>
                        <textarea class="form-control" id="workContent" rows="2" required></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>新增
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 人員列表 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-ul me-2"></i>人員列表
                </h5>
                <span class="badge bg-primary" id="workerCountBadge">0</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0" id="workerTable">
                        <thead>
                            <tr>
                                <th>工種</th>
                                <th>人數</th>
                                <th>位置</th>
                                <th>工作內容</th>
                                <th>進場時間</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 資料將由 JavaScript 動態填充 -->
                        </tbody>
                    </table>
                </div>
                <div class="text-center py-3 d-none" id="emptyState">
                    <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2">尚無人員資料</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部固定工具欄 -->
    <nav class="navbar fixed-bottom bg-light">
        <div class="container-fluid">
            <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#clearDataModal">
                    <i class="bi bi-trash me-2"></i>清空資料
                </button>
                <button type="button" class="btn btn-success" id="uploadBtn" onclick="uploadToGoogleSheet()">
                    <i class="bi bi-cloud-arrow-up me-2"></i>上傳資料
                </button>
            </div>
        </div>
    </nav>

    <!-- 清空資料確認 Modal -->
    <div class="modal fade" id="clearDataModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">確認清空</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        確定要清空所有資料嗎？此操作無法復原。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" onclick="clearAllData()">確認清空</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 上傳結果 Modal -->
    <div class="modal fade" id="uploadResultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">上傳結果</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="uploadResultBody">
                    <!-- 內容將由 JavaScript 動態填充 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container">
        <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" id="toastNotification">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle me-2"></i>
                    <span id="toastMessage"></span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 自定義 JS -->
    <script>
        // 全局變數
        let workers = [];
        
        // Google Apps Script 部署網址
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzk_JkmX3AtUCXVeoTLXq6yr6SEJ3ooVqUDrcb2qKAimRg9t5LXK7WAH0V3C2FkMtGYQQ/exec';
        
        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            // 設置當前時間為預設進場時間
            setDefaultEntryTime();
            
            // 註冊表單提交事件
            document.getElementById('workerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addWorker();
            });
            
            // 從 localStorage 載入資料
            loadWorkersFromLocalStorage();
            
            // 更新工人表格
            updateWorkerTable();
        });
        
        // 設置預設進場時間
        function setDefaultEntryTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('entryTime').value = `${hours}:${minutes}`;
        }
        
        // 添加工人
        function addWorker() {
            const workerType = document.getElementById('workerType').value;
            const workerCount = parseInt(document.getElementById('workerCount').value);
            const workLocation = document.getElementById('workLocation').value;
            const workContent = document.getElementById('workContent').value;
            const entryTime = document.getElementById('entryTime').value;
            
            // 添加到工人列表
            workers.push({
                type: workerType,
                count: workerCount,
                location: workLocation,
                content: workContent,
                entryTime: entryTime
            });
            
            // 更新表格
            updateWorkerTable();
            
            // 保存到 localStorage
            saveWorkersToLocalStorage();
            
            // 重置表單
            document.getElementById('workerForm').reset();
            setDefaultEntryTime();
            
            // 顯示成功提示
            showToast('新增成功');
        }
        
        // 更新工人表格
        function updateWorkerTable() {
            const tbody = document.querySelector('#workerTable tbody');
            const emptyState = document.getElementById('emptyState');
            const workerCountBadge = document.getElementById('workerCountBadge');
            
            // 清空表格
            tbody.innerHTML = '';
            
            // 更新計數
            workerCountBadge.textContent = workers.length;
            
            // 如果沒有資料，顯示空狀態
            if (workers.length === 0) {
                emptyState.classList.remove('d-none');
                return;
            }
            
            // 隱藏空狀態
            emptyState.classList.add('d-none');
            
            // 填充表格
            workers.forEach((worker, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${worker.type}</td>
                    <td>${worker.count}</td>
                    <td>${worker.location}</td>
                    <td>${worker.content}</td>
                    <td>${worker.entryTime}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeWorker(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // 移除工人
        function removeWorker(index) {
            // 從陣列中移除
            workers.splice(index, 1);
            
            // 更新表格
            updateWorkerTable();
            
            // 保存到 localStorage
            saveWorkersToLocalStorage();
            
            // 顯示提示
            showToast('已移除');
        }
        
        // 保存資料到 localStorage
        function saveWorkersToLocalStorage() {
            localStorage.setItem('workers', JSON.stringify(workers));
        }
        
        // 從 localStorage 載入資料
        function loadWorkersFromLocalStorage() {
            const savedData = localStorage.getItem('workers');
            if (savedData) {
                try {
                    workers = JSON.parse(savedData);
                } catch (e) {
                    console.error('解析本地存儲資料時發生錯誤:', e);
                    workers = [];
                }
            }
        }
        
        // 清空所有資料
        function clearAllData() {
            // 清空陣列
            workers = [];
            
            // 更新表格
            updateWorkerTable();
            
            // 清除 localStorage
            localStorage.removeItem('workers');
            
            // 關閉 Modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('clearDataModal'));
            modal.hide();
            
            // 顯示提示
            showToast('已清空所有資料');
        }
        
        // 上傳資料到 Google Sheet (使用 GET 方法)
        function uploadToGoogleSheet() {
            // 檢查是否有資料
            if (workers.length === 0) {
                showToast('沒有資料可上傳', 'danger');
                return;
            }
            
            // 禁用上傳按鈕
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>上傳中...';
            
            // 準備上傳資料
            const data = JSON.stringify(workers);
            
            // 使用 GET 方法發送請求到 Google Apps Script
            // 由於 GET 請求有 URL 長度限制，需要確保資料不會太大
            // 一般來說，幾十條記錄應該沒問題
            const url = `${SCRIPT_URL}?data=${encodeURIComponent(data)}`;
            
            fetch(url)
            .then(response => response.json())
            .then(result => {
                console.log('上傳結果:', result);
                
                // 顯示結果
                let resultHtml = '';
                
                if (result.result === 'success') {
                    resultHtml = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            ${result.message}
                        </div>
                        <p>上傳日期: ${result.details.date}</p>
                        <p>資料筆數: ${result.details.count}</p>
                    `;
                    
                    // 清空本地資料
                    workers = [];
                    updateWorkerTable();
                    localStorage.removeItem('workers');
                } else {
                    resultHtml = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            上傳失敗
                        </div>
                        <p>錯誤訊息: ${result.message}</p>
                    `;
                }
                
                document.getElementById('uploadResultBody').innerHTML = resultHtml;
                
                // 顯示結果 Modal
                const resultModal = new bootstrap.Modal(document.getElementById('uploadResultModal'));
                resultModal.show();
            })
            .catch(error => {
                console.error('上傳時發生錯誤:', error);
                
                // 顯示錯誤
                document.getElementById('uploadResultBody').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        上傳時發生錯誤
                    </div>
                    <p>錯誤訊息: ${error.message}</p>
                `;
                
                // 顯示結果 Modal
                const resultModal = new bootstrap.Modal(document.getElementById('uploadResultModal'));
                resultModal.show();
            })
            .finally(() => {
                // 恢復上傳按鈕
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="bi bi-cloud-arrow-up me-2"></i>上傳資料';
            });
        }
        
        // 顯示 Toast 通知
        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            
            // 設置訊息
            toastMessage.textContent = message;
            
            // 設置類型
            toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
            
            // 建立 Toast 實例並顯示
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
        }
    </script>
</body>
</html>
