<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>營造業人員進場登記</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
      .table-hover tbody tr:hover {
          background-color: #f5f5f5;
          cursor: pointer;
      }
      #currentTime {
          font-size: 0.9rem;
          color: #6c757d;
      }
  </style>
</head>
<body>
  <div class="container mt-5">
      <div class="text-center mb-4">
          <h2>
              <i class="bi bi-building-fill"></i> 工地人員進場登記
          </h2>
          <div id="currentTime" class="text-muted"></div>
      </div>
      
      <div class="card mb-4">
          <div class="card-header">
              <h5 class="card-title">
                  <i class="bi bi-plus-circle"></i> 新增人員
              </h5>
          </div>
          <div class="card-body">
              <form id="workerForm">
                  <div class="row">
                      <div class="col-md-3 mb-2">
                          <input type="text" class="form-control" id="workerName" placeholder="姓名" required>
                      </div>
                      <div class="col-md-3 mb-2">
                          <select class="form-select" id="workerType" required>
                              <option value="">工種</option>
                              <option value="鋼筋工">鋼筋工</option>
                              <option value="模板工">模板工</option>
                              <option value="水電工">水電工</option>
                              <option value="泥作工">泥作工</option>
                              <option value="焊接工">焊接工</option>
                              <option value="其他">其他</option>
                          </select>
                      </div>
                      <div class="col-md-3 mb-2">
                          <input type="text" class="form-control" id="workerCompany" placeholder="所屬廠商" required>
                      </div>
                      <div class="col-md-3 mb-2">
                          <button type="submit" class="btn btn-primary w-100">
                              <i class="bi bi-plus"></i> 新增
                          </button>
                      </div>
                  </div>
              </form>
          </div>
      </div>

      <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">
                  <i class="bi bi-list-ul"></i> 今日進場人員
              </h5>
              <div>
                  <span class="badge bg-primary" id="workerCount">0 人</span>
              </div>
          </div>
          <div class="card-body">
              <div class="table-responsive">
                  <table class="table table-striped table-hover" id="workerTable">
                      <thead>
                          <tr>
                              <th>姓名</th>
                              <th>工種</th>
                              <th>所屬廠商</th>
                              <th>進場時間</th>
                              <th>操作</th>
                          </tr>
                      </thead>
                      <tbody id="workerTableBody">
                          <!-- 動態填入 -->
                      </tbody>
                  </table>
              </div>
          </div>
          <div class="card-footer">
              <div class="row">
                  <div class="col">
                      <button id="submitAllBtn" class="btn btn-success w-100">
                          <i class="bi bi-cloud-upload"></i> 批次上傳
                      </button>
                  </div>
                  <div class="col">
                      <button id="clearAllBtn" class="btn btn-danger w-100">
                          <i class="bi bi-trash"></i> 清空列表
                      </button>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script>
      // 工人資料陣列
      let workers = [];

      // 更新當前時間
      function updateCurrentTime() {
          const now = new Date();
          const timeString = now.toLocaleString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false
          });
          document.getElementById('currentTime').textContent = `目前時間：${timeString}`;
      }

      // 每秒更新時間
      setInterval(updateCurrentTime, 1000);
      updateCurrentTime();

      // 表單提交事件
      document.getElementById('workerForm').addEventListener('submit', function(e) {
          e.preventDefault();
          
          const name = document.getElementById('workerName').value;
          const type = document.getElementById('workerType').value;
          const company = document.getElementById('workerCompany').value;
          
          // 建立工人物件
          const worker = {
              name: name,
              type: type,
              company: company,
              entryTime: new Date().toLocaleString('zh-TW', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit',
                  hour12: false
              })
          };

          // 加入陣列
          workers.push(worker);
          
          // 更新表格
          updateWorkerTable();
          
          // 清空輸入
          document.getElementById('workerName').value = '';
          document.getElementById('workerType').value = '';
          document.getElementById('workerCompany').value = '';
      });

      // 更新工人表格
      function updateWorkerTable() {
          const tableBody = document.getElementById('workerTableBody');
          const workerCountBadge = document.getElementById('workerCount');
          tableBody.innerHTML = '';

          workers.forEach((worker, index) => {
              const row = `
                  <tr>
                      <td>${worker.name}</td>
                      <td>${worker.type}</td>
                      <td>${worker.company}</td>
                      <td>${worker.entryTime}</td>
                      <td>
                          <button class="btn btn-sm btn-danger" onclick="removeWorker(${index})">
                              <i class="bi bi-trash"></i>
                          </button>
                      </td>
                  </tr>
              `;
              tableBody.innerHTML += row;
          });

          // 更新人數
          workerCountBadge.textContent = `${workers.length} 人`;
      }

      // 移除工人
      function removeWorker(index) {
          workers.splice(index, 1);
          updateWorkerTable();
      }

      // 批次上傳
      document.getElementById('submitAllBtn').addEventListener('click', async function() {
          if (workers.length === 0) {
              alert('請先新增工人');
              return;
          }

          try {
              const response = await fetch('https://docs.google.com/spreadsheets/d/1T-CX30M_FL9w0vpnOIczJ-qNW8boUTnpLp508H_Sn68/edit?gid=0#gid=0', {
                  method: 'POST',
                  body: JSON.stringify(workers)
              });

              const result = await response.json();
              
              if (result.status === 'success') {
                  alert('批次上傳成功');
                  workers = []; // 清空陣列
                  updateWorkerTable();
              } else {
                  alert('上傳失敗：' + result.message);
              }
          } catch (error) {
              alert('上傳發生錯誤：' + error);
          }
      });

      // 清空列表
      document.getElementById('clearAllBtn').addEventListener('click', function() {
          if (confirm('確定要清空所有人員嗎？')) {
              workers = [];
              updateWorkerTable();
          }
      });
  </script>
</body>
</html>
