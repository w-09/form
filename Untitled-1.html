function doPost(e) {
  try {
    // 安全的資料解析
    var jsonString = e.postData.contents || '[]';
    var data = JSON.parse(jsonString);
    
    console.log('收到的資料：', data);
    
    // 錯誤檢查
    if (!Array.isArray(data)) {
      return ContentService.createTextOutput(
        JSON.stringify({
          status: 'error', 
          message: '資料格式錯誤，需要陣列'
        })
      ).setMimeType(ContentService.MimeType.JSON);
    }
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // 動態寫入標題列
    if (sheet.getLastRow() === 0) {
      sheet.appendRow([
        '姓名', 
        '工種', 
        '所屬廠商', 
        '進場時間', 
        '紀錄時間'
      ]);
    }
    
    // 逐筆寫入資料
    data.forEach(function(worker) {
      sheet.appendRow([
        worker.name || '未知', 
        worker.type || '未知', 
        worker.company || '未知', 
        worker.entryTime || new Date().toLocaleString(), 
        new Date().toLocaleString()
      ]);
    });
    
    // 回傳成功訊息
    return ContentService.createTextOutput(
      JSON.stringify({
        status: 'success', 
        message: '成功新增 ' + data.length + ' 筆資料'
      })
    ).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    // 詳細的錯誤回傳
    return ContentService.createTextOutput(
      JSON.stringify({
        status: 'error', 
        message: '處理資料時發生錯誤：' + error.toString()
      })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

// 增加 doGet 方法，方便測試
function doGet(e) {
  return ContentService.createTextOutput(
    JSON.stringify({
      status: 'ok',
      message: 'Apps Script 服務正常運作'
    })
  ).setMimeType(ContentService.MimeType.JSON);
}
